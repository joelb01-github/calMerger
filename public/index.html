<!DOCTYPE html>
<html lang="en" dir="ltr">

  <head>
    <meta charset="utf-8">
    <title>El server de Jojos</title>
  </head>

  <body>
    <h1>El server de Jojos</h1>
    <p>Let the magic begin!</p>
    <!-- POST used so data part of req.body -->
    <form method="post" enctype="multipart/form-data">
      <div>
        <label for="file1">Select first ics document:</label>
        <input type="file" id="file1" name="file1">
      </div>
      <div>
        <label for="file2">Select second ics document:</label>
        <input type="file" id="file2" name="file2">
      </div>
      <div>
        <button type="submit">Submit</button>
      </div>
    </form>
    <div id="return"></div>

    <script type="text/javascript" >
      const form = document.querySelector('form');
      const url = '/aggreg';

      form.addEventListener('submit', event => {
        event.preventDefault(); // preventing sending the request

        console.log(".. gathering files attached");
        // Gather files and begin FormData
        const fileNode = document.querySelectorAll("input[type='file']");
        var formData = new FormData();
        // Append files to files array
        for (var i=0;i<fileNode.length;i++){
          formData.append('files[]', fileNode[i].files[0]);
        }

        if(fileNode.length < 2) {
          try {
            throw new Error("You need at least 2 files selected");
          } catch (e) {
            console.log(e.name + ': ' + e.message);
          }
        }
        else {
          console.log(".. sending data to the server");
          for (var i=0; i< formData.getAll('files[]').length;i++) {
            console.log(".. sending: " + formData.getAll('files[]')[i].name);
          }
          fetch(url, {
            method: 'POST',
            body: formData
          })
          .then(response => {
              console.log(response);
              window.open('http://localhost:3000/', '_blank');
              // TODO: let the user downlaod the response
          })
          .catch(err => console.error(err));
        }
      });
    </script>
  </body>

</html>
